import{o as e,a as t,d as s,z as a,j as i,aX as o,a2 as n,C as r,n as d,A as c,a6 as m,a1 as l,u,k as p,r as h,M as f,W as v,h as b,aZ as g,i as x,b8 as I,b9 as y,b2 as j,a7 as k,E as w}from"./index.mlCxaiYE.js";import{i as C}from"./authenticated.03alztlO.js";import{R as N}from"./RevisionHelper.9xLOzGQo.js";import{P as A}from"./Badge.sHfYRIgC.js";import{A as M,a as S}from"./TeamLogo.qV1feKYB.js";import{L,A as P}from"./Item.dGEOVRdT.js";import{T}from"./Time.rp9cc_zo.js";import{b as U,u as z,O as B,T as R,s as D,a as H}from"./DocumentContext.hhTeDqBR.js";import{C as E}from"./InputSelectPermission.lb2lIKIy.js";import{r as _,c as q}from"./revisions.HHg7AZxX.js";import{u as X}from"./Switch.3DOmHSIs.js";import{S as F}from"./SidebarLayout.Ev8iLcgK.js";import"./useCurrentUser.zlImhYTS.js";import"./useCurrentTeam.fRZpnoZU.js";import"./usePolicy.wYF8wJNp.js";import"./index.esm.XsAbwjVB.js";import"./urls.doI9odX4.js";import"./Notice.4wB6_cwE.js";import"./useBoolean.4JQO1FDN.js";import"./LoadingIndicatorBar.mGaD64ZX.js";import"./PlaceholderText.UNfhMHoO.js";import"./ButtonLink.tgoiIjKJ.js";import"./routeHelpers.MPg4vHxP.js";import"./Scene.tZk0YIWv.js";import"./PopoverDisclosure.OO70kItq.js";import"./SharedLayoutContext.2BBc39h7.js";const O=e((function RevisionMenu({document:e,className:n}){const r=U({modal:!0}),{t:d}=t(),c=z({activeDocumentId:e.id});return s(a,{children:[i(B,{className:n,"aria-label":d("Show menu"),...r}),i(E,{...r,"aria-label":d("Revision options"),children:i(R,{...r,items:[o(_,c),D(),o(q,c)]})})]})})),W=n(['&::before{content:"";display:block;position:absolute;top:-8px;left:22px;width:1px;height:calc(50% - 14px + 8px);background:',";mix-blend-mode:",';z-index:1;}&:first-child::before{display:none;}&:nth-child(2)::before{display:none;}&::after{content:"";display:block;position:absolute;top:calc(50% + 14px);left:22px;width:1px;height:calc(50% - 14px);background:',";mix-blend-mode:",";z-index:1;}&:last-child::after{display:none;}h3 + &::before{display:none;}"],r("divider"),(e=>e.theme.isDark?"lighten":"multiply"),r("divider"),(e=>e.theme.isDark?"lighten":"multiply")),Z=d(c).withConfig({componentId:"sc-1amjaws-0"})(["height:24px;"]),G=d.li.withConfig({componentId:"sc-1amjaws-1"})(["display:flex;align-items:center;gap:8px;list-style:none;margin:8px 0;padding:4px 10px;white-space:nowrap;position:relative;time{white-space:nowrap;}svg{flex-shrink:0;}",""],W),J=d(m).withConfig({componentId:"sc-1amjaws-2"})(["height:24px;"]),K=d(L).withConfig({componentId:"sc-1amjaws-3"})(["border:0;position:relative;margin:8px 0;padding:8px;border-radius:8px;"," ","{opacity:0.5;&:","{opacity:1;}}"],W,P,l),Q=e((({event:e,document:o,...n})=>{const{t:r}=t(),{revisions:d,users:m}=u(),l="actorId"in e?m.get(e.actorId):void 0,g="userId"in e?m.get(e.userId):void 0,x=p(),I=H(),y=h.useRef(!1),j={userName:l?.name},k="revisions.create"===e.name,w=e.id===N.latestId(o.id);let C,A,L;const P=h.useRef(null);switch(e.name){case"revisions.create":A=i(b.EditIcon,{size:16}),C=e.latest?s(a,{children:[r("Current version")," · ",l?.name]}):r("{{userName}} edited",j),L={pathname:v(o,w?"latest":e.id),state:{sidebarContext:I,retainScrollPosition:!0}};break;case"documents.archive":A=i(b.ArchiveIcon,{}),C=r("{{userName}} archived",j);break;case"documents.unarchive":A=i(b.RestoreIcon,{}),C=r("{{userName}} restored",j);break;case"documents.delete":A=i(b.TrashIcon,{}),C=r("{{userName}} deleted",j);break;case"documents.add_user":A=i(b.UserIcon,{}),C=r("{{userName}} added {{addedUserName}}",{...j,addedUserName:g?.name??r("a user")});break;case"documents.remove_user":A=i(b.CrossIcon,{}),C=r("{{userName}} removed {{removedUserName}}",{...j,removedUserName:g?.name??r("a user")});break;case"documents.restore":A=i(b.RestoreIcon,{}),C=r("{{userName}} moved from trash",j);break;case"documents.publish":A=i(b.PublishIcon,{}),C=r("{{userName}} published",j);break;case"documents.unpublish":A=i(b.UnpublishIcon,{}),C=r("{{userName}} unpublished",j);break;case"documents.move":A=i(b.MoveIcon,{}),C=r("{{userName}} moved",j);break;default:f.warn("Unhandled event",{event:e})}if(!C)return null;const U="string"==typeof L?x.pathname===L:x.pathname===L?.pathname;return o.isDeleted&&(L=void 0),"revisions.create"===e.name?i(K,{small:!0,exact:!0,to:L,title:i(T,{dateTime:e.createdAt,format:{en_US:"MMM do, h:mm a",fr_FR:"'Le 'd MMMM 'à' H:mm"},relative:!1,addSuffix:!0,onClick:()=>{P.current?.focus()}}),image:i(M,{model:l,size:S.Large}),subtitle:C,actions:k&&U&&!e.latest?i(J,{children:i(O,{document:o,revisionId:e.id})}):void 0,onMouseEnter:async()=>{o.isDeleted||"revisions.create"!==e.name||w||y.current||(await d.fetch(e.id,{force:!0}),y.current=!0)},ref:P,...n}):s(G,{children:[i(Z,{size:"xsmall",type:"secondary",children:A}),s(c,{size:"xsmall",type:"secondary",children:[C," ·"," ",i(T,{dateTime:e.createdAt,relative:!0,shorten:!0,addSuffix:!0})]})]})})),V=h.memo((function PaginatedEventList2({empty:e,heading:t,events:s,fetch:a,options:o,document:n,...r}){return i(Y,{items:s,empty:e,heading:t,fetch:a,options:o,renderItem:e=>i(Q,{event:e,document:n},e.id),renderHeading:e=>i($,{children:e}),...r})})),Y=d(A).withConfig({componentId:"sc-18ao1qd-0"})(["padding:0 12px;"]),$=d("h3").withConfig({componentId:"sc-18ao1qd-1"})(["font-size:15px;padding:0 4px;"]),ee=["documents.publish","documents.unpublish","documents.archive","documents.unarchive","documents.delete","documents.restore","documents.add_user","documents.remove_user","documents.move"];const te=d(w).withConfig({componentId:"sc-1gd1ron-0"})(["padding:0 12px;"]),se=e((function History(){const{events:e,documents:s,revisions:a}=u(),{t:o}=t(),n=g(),r=x(),d=H(),c=s.getByUrl(n.params.documentSlug),[,m]=h.useState(0),l=h.useMemo((()=>({revisions:0,events:0})),[]),p=h.useCallback((e=>e instanceof I?{id:e.id,name:"revisions.create",actorId:e.createdBy.id,createdAt:e.createdAt,latest:!1}:{id:e.id,name:e.name,actorId:e.actorId,userId:e.userId,createdAt:e.createdAt}),[]),f=h.useCallback((async()=>{if(!c)return[];const[t,s]=await Promise.all([a.fetchPage({documentId:c.id,offset:l.revisions,limit:y.defaultLimit}),e.fetchPage({events:ee,documentId:c.id,offset:l.events,limit:y.defaultLimit})]),i=j([...t,...s].map(p),"createdAt","desc").slice(0,y.defaultLimit),o=i.filter((e=>"revisions.create"===e.name)).length;return l.revisions+=o,l.events+=i.length-o,m((e=>++e)),i}),[c,a,e,p,l]),v=h.useMemo((()=>{if(!c)return[];const e=N.latestId(c.id);return a.filter((t=>t.id!==e&&t.documentId===c.id)).slice(0,l.revisions).map(p)}),[c,a,l.revisions,p]),b=h.useMemo((()=>c?e.filter({documentId:c.id}).slice(0,l.events).map(p):[]),[c,e,l.events,p]),w=h.useMemo((()=>{const e=j([...v,...b],"createdAt","desc"),t=e.find((e=>"revisions.create"===e.name));if(t&&c){const s=a.get(t.id);s?.title!==c.title||!C(s.data,c.data)?(a.remove(N.latestId(c.id)),e.unshift({id:N.latestId(c.id),name:"revisions.create",createdAt:c.updatedAt,actorId:c.updatedBy?.id??"",latest:!0})):t&&(t.latest=!0)}return e}),[a,c,v,b]),A=h.useCallback((()=>{c?r.push({pathname:k(c),state:{sidebarContext:d}}):r.goBack()}),[r,c,d]);return X("Escape",A),i(F,{title:o("History"),onClose:A,children:c?i(V,{"aria-label":o("History"),fetch:f,events:w,document:c,empty:i(te,{children:o("No history yet")})}):null})}));export{se as default};
