import{k as e,a as t,d as s,j as i,H as o,F as a,E as r,i as n,B as c,r as d,o as u,u as m,bD as l,s as h,bE as p,V as f,ao as j,bF as g,bw as v,bG as w,bx as y,z as D,M as E,bH as S}from"./index.mlCxaiYE.js";import{R as I}from"./RevisionHelper.9xLOzGQo.js";import{N as b}from"./Notice.4wB6_cwE.js";import{S as x}from"./Scene.tZk0YIWv.js";import{u as C,q as T,f as k,E as P}from"./DocumentContext.hhTeDqBR.js";import{E as L,L as A,D as V}from"./Loading.9UhuAPJB.js";import{u as B}from"./useCurrentTeam.fRZpnoZU.js";import{u as F}from"./useCurrentUser.zlImhYTS.js";import{u as R}from"./usePolicy.wYF8wJNp.js";import"./PlaceholderText.UNfhMHoO.js";import"./LoadingIndicatorBar.mGaD64ZX.js";import"./Switch.3DOmHSIs.js";import"./PopoverDisclosure.OO70kItq.js";import"./InputSelectPermission.lb2lIKIy.js";import"./TeamLogo.qV1feKYB.js";import"./useBoolean.4JQO1FDN.js";import"./Badge.sHfYRIgC.js";import"./Item.dGEOVRdT.js";import"./Time.rp9cc_zo.js";import"./index.esm.XsAbwjVB.js";import"./SharedLayoutContext.2BBc39h7.js";import"./cloneDeep.KovzE0Sn.js";import"./OutlineIcon.Lni4fHNe.js";import"./index.njNghNAe.js";import"./useFocusedComment.Wp-Vuc-6.js";import"./Star.r69PtoVf.js";import"./PopoverButton.AWtPNgE3.js";import"./Actions.u9jjnQ1W.js";import"./DocumentViews.hDT4MR_D.js";import"./Facepile.0K3TyxgD.js";import"./revisions.HHg7AZxX.js";import"./Subheading.reqgXMWW.js";import"./Tabs.dkNXhqZm.js";import"./VisualElementDragControls.jrFnrF4j.js";const Error402=()=>{const n=e(),{t:c}=t(),d=n.state?.title??c("Payment Required");return s(x,{title:d,children:[i(o,{children:d}),i(a,{style:{maxWidth:500},column:!0,children:i(r,{size:"large",children:i(b,{children:"This document cannot be viewed with the current edition. Please upgrade to a paid license to restore access."})})})]})},Error403=()=>{const{t:e}=t(),d=n(),u=C();return s(x,{title:e("No access to this doc"),children:[i(o,{children:e("No access to this doc")}),s(a,{gap:20,style:{maxWidth:500},column:!0,children:[s(r,{size:"large",children:[e("It doesnâ€™t look like you have permission to access this document.")," ",e("Please request access from the document owner.")]}),s(a,{gap:8,children:[i(c,{action:T,context:u,hideIcon:!0,children:e("Home")}),i(c,{onClick:d.goBack,neutral:!0,children:e("Go back")})]})]})]})};function MarkAsViewed(e){const{document:t,children:s}=e,i=d.useRef(null);return d.useEffect((()=>(i.current=setTimeout((async()=>{const e=await t.view();e&&t.updateLastViewed(e)}),3e3),()=>{i.current&&clearTimeout(i.current)})),[t]),s||null}const H=u((function DataLoader({match:t,children:o}){const{ui:a,views:r,shares:n,comments:c,documents:u,revisions:S}=m(),b=B(),x=F(),{setDocument:C}=k(),[T,V]=d.useState(null),{revisionId:H,shareId:N,documentSlug:q}=t.params,z=u.getByUrl(t.params.documentSlug)??u.get(t.params.documentSlug);z&&C(z);const M=H?S.get("latest"===H?I.latestId(z?.id):H):void 0,W=z?u.getSharedTree(z.id):void 0,U=t.path===l||t.path.startsWith(h()),G=U||!x?.separateEditMode,O=R(z),J=e();d.useEffect((()=>{!async function fetchDocument(){try{await u.fetchWithSharedTree(q,{shareId:N})}catch(e){V(e)}}()}),[a,u,N,q]),d.useEffect((()=>{!async function fetchRevision(){if(H&&"latest"!==H)try{await S.fetch(H)}catch(e){V(e)}}()}),[S,H]),d.useEffect((()=>{!async function fetchRevision(){if(z&&"latest"===H)try{await S.fetchLatest(z.id)}catch(e){V(e)}}()}),[z,H,S]),d.useEffect((()=>{!async function fetchViews(){if(z?.id&&!z?.isDeleted&&!H)try{await r.fetchPage({documentId:z.id})}catch(e){E.error("Failed to fetch views",e)}}()}),[z?.id,z?.isDeleted,H,r]);const X=d.useCallback((async(e,t)=>{if(!z)throw new Error("Document not loaded yet");return(await u.create({collectionId:t?void 0:z.collectionId,parentDocumentId:t?z.id:z.parentDocumentId,data:p.getEmptyDocument(),...e},{publish:!z.isDraft||void 0})).url}),[z,u]);if(d.useEffect((()=>{if(z){if(a.setActiveDocument(z),!O.update&&U&&!z.template)return void f.push(z.url);!O.read||z.isDeleted||H||(b.getPreference(j.Commenting)&&c.fetchAll({documentId:z.id,limit:100,direction:"ASC"}),n.fetch(z.id).catch((e=>{if(!(e instanceof g))throw e})))}}),[O.read,O.update,z,U,c,b,n,a,H]),T)return i(T instanceof v?L:T instanceof w?Error402:T instanceof y?Error403:P,{});if(!1===O.read)return i(P,{});if(!z||H&&!M)return i(D,{children:i(A,{location:J})});const Y=O.update&&!z.isArchived&&!H,Z=!G||!Y;return s(D,{children:[!N&&!M&&i(MarkAsViewed,{document:z}),i(d.Fragment,{children:o({document:z,revision:M,abilities:O,readOnly:Z,onCreateLink:X,sharedTree:W})},Y?"edit":"read")]})}));function DocumentScene(e){const{ui:t}=m(),s=n(),{documentSlug:o,revisionId:a}=e.match.params,r=e.location.pathname,[,c]=S();d.useEffect((()=>{c(r)}),[r,c]),d.useEffect((()=>()=>t.clearActiveDocument()),[t]),d.useEffect((()=>{e.location.state?.sidebarContext||s.replace({...e.location,state:{...e.location.state,sidebarContext:"collections"}})}),[e.location,s]);const u=o?o.split("-"):[],l=[u.length?u[u.length-1]:void 0,a].join("/");return i(H,{match:e.match,history:e.history,location:e.location,children:e=>i(V,{...e})},l)}export{DocumentScene as default};
